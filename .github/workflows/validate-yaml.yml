name: Validate YAML files

on:
  push:
    branches:
      - main
    paths:
      - 'characters/**'
      - 'countries/**'
      - 'locations/**'
  pull_request:
    types: ['opened', 'synchronize', 'reopened', 'ready_for_review']
    paths:
      - 'characters/**'
      - 'countries/**'
      - 'locations/**'

jobs:
  yaml-lint:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    name: Check YAML validity
    permissions:
      contents: read
      pull-requests: write  # needed to post PR comments

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files (PR)
        if: github.event_name == 'pull_request'
        id: pr_changes
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '^(characters/|countries/|locations/)' | grep -E '.ya?ml$')
          CHANGED_FILES_ENCODED=$(echo -n "$CHANGED_FILES" | base64 -w 0)
          echo "changed=$CHANGED_FILES_ENCODED" >> $GITHUB_OUTPUT

      - name: Get changed files (Push)
        if: github.event_name == 'push'
        id: push_changes
        run: |
          git fetch origin ${{ github.ref_name }}
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep -E '^(characters/|countries/|locations/)' | grep -E '.ya?ml$')
          CHANGED_FILES_ENCODED=$(echo -n "$CHANGED_FILES" | base64 -w 0)
          echo "changed=$CHANGED_FILES_ENCODED" >> $GITHUB_OUTPUT

      - name: Print changed files
        id: print_changed
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(echo ${{ steps.pr_changes.outputs.changed }} | base64 -d)
            echo "Changed files: $CHANGED_FILES"
            echo "changed=${{ steps.pr_changes.outputs.changed }}" >> $GITHUB_OUTPUT
          else
            CHANGED_FILES=$(echo ${{ steps.push_changes.outputs.changed }} | base64 -d)
            echo "Changed files: $CHANGED_FILES"
            echo "changed=${{ steps.push_changes.outputs.changed }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate YAML files
        id: validate
        run: |
          set +e
          
          echo "Checking changed YAML files..."
          CHANGED_FILES=$(echo ${{ steps.print_changed.outputs.changed }} | base64 -d)
          has_error=0
          while IFS= read -r file; do
            echo "Validating $file"
            python scripts/yaml-linter.py "$file"
            if [ $? -ne 0 ]; then
              has_error=1
            fi
          done <<< "$CHANGED_FILES"

          if [ $has_error -eq 0 ]; then
            echo "âœ… All YAML files are valid."
            exit 0
          else
            echo "ðŸš« errors encountered while linting YAML files."
            exit 1
          fi